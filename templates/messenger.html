<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIN Messenger - Свободу слову!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style2.css') }}">
</head>

<body>
    <div class="background-container">
        <img src="{{ url_for('static', filename='images/bgmes.jpg') }}" alt="Фон" class="background-image">
    </div>

    <div class="shapes">
        <div id="searchblock">
            <input id="inputsearchuser">
            <button id="buttonsearch">Search By</button>
            <div class="by">
                <a href="#">Name</a>
                <a href="#">Phone</a>
                <a href="#" color="red">Id</a>
            </div>
        </div>

        <div class="optionsblock">
            <div class="swimopt">
                <button id="optionsbtn">Настройки</button>
                <div class="optionsmenu">
                    <a href="#">Профиль</a>
                    <a href="#">Выйти</a>
                    <a href="#" color="red">Удалить аккаунт</a>
                </div>
            </div>
        </div>
    </div>


    <div class="mesenger_body">
        <div id="chatbox">
        </div>
        <div class="chat">
            <div class="input_msg">
                <input id="input_message">
                <button id="send_btn">Send</button>
            </div>
        </div>
    </div>

    <div id="SearchUser">
    </div>

    <div id="MainChatCreator">
        <div class="WhatCreate"></div>
    </div>


</body>
<script>
    const DataUser = localStorage.getItem('userdata');
    console.log(DataUser);
    if (DataUser) {
        const Data = JSON.parse(DataUser);
        const ChatBox = document.getElementById("chatbox")
        ChatBox.innerHTML = '';
        fetch("/userchatlist", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: Data.email
                }),
            })
            .then(response => response.json())
            .then(result => {
                const chats = result.chats;
                chats.forEach(chat => {
                    ChatBox.innerHTML += `
                    <div class=${'chatinfo'}>
                        <img src="${chat.avatar}" class=${'chat-avatar'} alt="${0} ">
                        <b class=${'chat-name'}>${chat.name}</b> 
                    </div>
                `;
                });

            })
            .catch(error => {
                console.error("Ошибка сети:", error);
            });
        document.getElementById("inputsearchuser").addEventListener("focus", function() {
            document.querySelector("#SearchUser").style.display = "flex";
        });
        document.getElementById("inputsearchuser").addEventListener("blur", function() {
            document.querySelector("#SearchUser").style.display = "none";
        });
    }

    const button = document.getElementById('buttonsearch');
    const menu = document.querySelector('.by');
    const InputSearch = document.getElementById("inputsearchuser");
    let timeout;

    function showMenu() {
        const rect = button.getBoundingClientRect();
        menu.style.display = 'flex';
        menu.style.position = 'absolute';
        menu.style.top = (rect.bottom + 2) + 'px';
        menu.style.left = rect.left + 'px';
        menu.style.minWidth = rect.width + 'px';

        // Запускаем анимацию
        setTimeout(() => menu.classList.add('show'), 10);
        clearTimeout(timeout);
    }

    function hideMenu() {
        menu.classList.remove('show');
        timeout = setTimeout(() => {
            menu.style.display = 'none';
        }, 200); // Ждем окончания анимации
    }

    button.addEventListener('mouseenter', showMenu);
    button.addEventListener('mouseleave', hideMenu);

    menu.addEventListener('mouseenter', function() {
        clearTimeout(timeout);
        menu.classList.add('show');
    });

    menu.addEventListener('mouseleave', hideMenu);

    const menuLinks = document.querySelectorAll('.by a');

    menuLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // Отменяем переход по ссылке

            const linkText = this.textContent;
            console.log(`Нажата ссылка: ${linkText}`);

            // Определяем какая именно ссылка нажата
            switch (linkText) {
                case 'Name':
                    SearchBy("name");
                    break;
                case 'Phone':
                    SearchBy("phone");
                    break;
                case 'Id':
                    SearchBy("id");
                    break;
            }

            // Закрываем меню после выбора
            this.closest('.by').style.display = 'none';
            document.querySelector("#SearchUser").style.display = "flex";
        });
    });

    function SearchBy(type_search) {
        console.log('Выбран поиск по имени ${}');
        // Ваш код для поиска по имени
        UserBox = document.getElementById("SearchUser");
        if (InputSearch.value.trim() != "") {
            fetch("/SearchUserBy", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "type": type_search,
                        "request": InputSearch.value.trim()
                    }),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.sucess) {
                        const users = result.userlist;
                        UserBox.innerHTML = "";
                        users.forEach(user => {
                            if (user.photo === null) {
                                user.photo = "static/images/Uniknown.png"
                            }
                            UserBox.innerHTML += `
                        <div class=${'User'}>
                            <img src="${user.photo}" class=${'useravatar'} alt="${0} ">
                            <b class=${'username'} id=${user.id}>${user.name}</b> 
                        </div>
                    `;
                        });
                    } else {

                    }

                })
                .catch(error => {
                    console.error("Ошибка сети:", error);
                });
        }
    }

    document.getElementById('SearchUser').addEventListener('click', function(event) {
        // Проверяем, что клик был по элементу с классом User или его дочерним элементам
        const userElement = event.target.closest('.User');
        if (userElement) {
            // Находим элементы внутри User
            const username = userElement.querySelector('.username');
            const userAvatar = userElement.querySelector('.useravatar');
            const userId = username.id;
            // Вызываем функцию обработки
            CreateChat(userId, userElement);
        }
    });

    function CreateChat(userId, element) {
        console.log(`Обрабатываем пользователя с ID: ${userId}`);
        document.getElementById("MainChatCreator").style.display = "block";

    }
</script>
</body>

</html>