<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIN Messenger - –°–≤–æ–±–æ–¥—É —Å–ª–æ–≤—É!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style2.css') }}">
</head>

<body>
    <div class="background-container">
        <img src="{{ url_for('static', filename='images/bgmes.jpg') }}" alt="–§–æ–Ω" class="background-image">

    </div>

    <div class="shapes">
        <div id="searchblock">
            <input id="inputsearchuser">
            <button class="zzz" id="buttonsearch">Search By</button>
            <div class="by">
                <a class="zzz" href="#">Name</a>
                <a class="zzz" href="#">Phone</a>
                <a class="zzz" href="#" color="red">Id</a>
            </div>
        </div>

        <div class="optionsblock">
            <div class="swimopt">
                <button id="optionsbtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <div class="optionsmenu">
                    <a id="profil" href="#">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <a id="exit" href="#">–í—ã–π—Ç–∏</a>
                    <a id="deletemyacc" href="#" color="red">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
                </div>
            </div>
        </div>
    </div>


    <div class="mesenger_body">
        <div id="chatbox">
        </div>
        <div class="chat">
            <div class="input_msg">
                <input id="input_message">
                <button id="send_btn">Send</button>
            </div>
        </div>
    </div>

    <div id="SearchUser">
    </div>

    <div id="MainChatCreator">
        <div class="WhatCreate">
            <p id="usname">–í—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å </p>
            <div class="formdata">
                <div>
                    <img src="" id="user_ava" alt="0">
                </div>
                <div class="betta">
                    <p>–ò–º—è</p>
                    <p>–¢–µ–ª–µ—Ñ–æ–Ω</p>
                    <p>ID</p>
                </div>
            </div>
            <p>–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</p>
            <div id="about_user">
                <p class="long-text">–ù–µ —É–∫–∞–∑–∞–Ω–æ</p>
            </div>
            <div class="button_box">
                <button class="cancel_class" id="cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="createchatbtn_class" id="create_chatbtn">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
            </div>
        </div>
    </div>
    <div style="display: none;" id="red">
        <div class="deletebox">
            <p style="font-size: 27px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</p>
            <p style="font-size: 15px; margin:4px; justify-self: center;">–≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã</p>
            <div class="button_box2">
                <button class="no" id="nodelete">–ù–µ—Ç</button>
                <button class="yes" id="yesdelete">–î–∞</button>
            </div>
        </div>
        <div style="display: none;" class="why">
            <p style="font-size: 22px;">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —Ä–µ—à–∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
            <textarea id="txa" class="inpwhy"></textarea>
            <div class="button_box2">
                <button class="no" id="nodelete">–û—Ç–º–µ–Ω–∞</button>
                <button class="yes" id="yesdelete2">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div style="display: none;" class="MainCreateProfil">
        <div class="CreateProfil">
            <p style="font-size: 30px; margin-bottom: 8px; margin-top:10px">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</p>
            <img id="my_photo">
            <div style="display: flex; align-items: center; margin:6px">
                <p style="font-size: 22px; margin-right: 10px">–ò–º—è:</p>
                <input>
            </div>
            <div class="pol">
                <p style="margin-right: 35px; font-size:22px">–ü–æ–ª:</p>
                <input class="chek" type="checkbox">
                <p style="margin-right: 28px; margin-left:3px">–ú—É–∂.</p>
                <input class="chek" type="checkbox">
                <p style="padding-left: 3px;">–ñ–µ–Ω.</p>
            </div>
            <div style="display: flex; align-items: center; margin:6px">
                <p style="font-size: 22px; margin-right: 10px">–í–æ–∑—Ä–∞—Å—Ç:</p>
                <input type="number">
            </div>
            <div style="display: flex; align-items: center; margin:6px">
                <p style="font-size: 22px; margin-right: 10px">–î–†:</p>
                <input type="date">
            </div>
            <p>–°–≤–æ—ë</p>
            <textarea style="min-height: 30px;"></textarea>
            <div class="btnboxprof">
                <button id="prof_canc">–û—Ç–º–µ–Ω–∞</button>
                <button id="prof_save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

</body>
<script>
    const DataUser = localStorage.getItem('userdata');
    console.log(DataUser);



    // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - —Ç–æ–ª—å–∫–æ fetch –∏ then
    const images = [{
        name: 'avatar',
        url: '/static/images/Uniknown.png'
    }, {
        name: 'logo',
        url: '/static/images/logo.png'
    }, {
        name: "notfind",
        url: "static/images/notfind.png"
    }, {
        name: 'fone',
        url: "static/images/bgmes.jpg"
    }];

    function loadAllImages() {
        images.forEach(image => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤ localStorage
            const saved = localStorage.getItem(image.name);

            if (saved) {
                // –£–∂–µ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º
                console.log(`‚úÖ ${image.name} - –∏–∑ –∫—ç—à–∞`);

            } else {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é
                console.log(`üì• ${image.name} - –∑–∞–≥—Ä—É–∂–∞–µ–º...`);

                fetch(image.url)
                    .then(response => response.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onload = function() {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                            localStorage.setItem(image.name, this.result);
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                            console.log(`‚úÖ ${image.name} - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`);
                        };
                        reader.readAsDataURL(blob);
                    })
                    .catch(error => {
                        console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${image.name}:`, error);
                    });
            }
        });
    }

    // –ü—Ä–æ—Å—Ç–æ –≤—ã–∑–æ–≤–∏ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
    loadAllImages();



    if (DataUser) {
        const Data = JSON.parse(DataUser);
        const ChatBox = document.getElementById("chatbox")
        ChatBox.innerHTML = '';
        fetch("/userchatlist", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: Data.email
                }),
            })
            .then(response => response.json())
            .then(result => {
                const chats = result.chats;
                chats.forEach(chat => {
                    ChatBox.innerHTML += `
                    <div class=${'chatinfo'}>
                        <img src="${chat.avatar}" class=${'chat-avatar'} alt="${0} ">
                        <b class=${'chat-name'}>${chat.name}</b> 
                    </div>
                `;
                });

            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
                window.localStorage.clear();
                window.location.href = "";
            });
        document.getElementById("inputsearchuser").addEventListener("focus", function() {
            document.querySelector("#SearchUser").style.display = "flex";
        });
        document.getElementById("inputsearchuser").addEventListener("blur", function() {
            document.querySelector("#SearchUser").style.display = "none";
        });
    } else {
        window.close();
        window.location.href = '/';

    }

    const button = document.getElementById('buttonsearch');
    const menu = document.querySelector('.by');
    const InputSearch = document.getElementById("inputsearchuser");
    let timeout;

    function showMenu() {
        const rect = button.getBoundingClientRect();
        menu.style.display = 'flex';
        menu.style.position = 'absolute';
        menu.style.top = (rect.bottom + 2) + 'px';
        menu.style.left = rect.left + 'px';
        menu.style.minWidth = rect.width + 'px';

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        setTimeout(() => menu.classList.add('show'), 10);
        clearTimeout(timeout);
    }

    function hideMenu() {
        menu.classList.remove('show');
        timeout = setTimeout(() => {
            menu.style.display = 'none';
        }, 200); // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
    }

    button.addEventListener('mouseenter', showMenu);
    button.addEventListener('mouseleave', hideMenu);

    menu.addEventListener('mouseenter', function() {
        clearTimeout(timeout);
        menu.classList.add('show');
    });

    menu.addEventListener('mouseleave', hideMenu);

    const menuLinks = document.querySelectorAll('.by a');

    menuLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ

            const linkText = this.textContent;
            console.log(`–ù–∞–∂–∞—Ç–∞ —Å—Å—ã–ª–∫–∞: ${linkText}`);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ —Å—Å—ã–ª–∫–∞ –Ω–∞–∂–∞—Ç–∞
            switch (linkText) {
                case 'Name':
                    SearchBy("name");
                    break;
                case 'Phone':
                    SearchBy("phone");
                    break;
                case 'Id':
                    SearchBy("id");
                    break;
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
            this.closest('.by').style.display = 'none';
            document.querySelector("#SearchUser").style.display = "flex";
        });
    });
    document.addEventListener("click", function(e) {
        if (e.target.className !== "zzz") {
            document.querySelector("#SearchUser").style.display = "none";
        }
    })

    function SearchBy(type_search) {
        //console.log('–í—ã–±—Ä–∞–Ω –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ ${}');
        // –í–∞—à –∫–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏
        UserBox = document.getElementById("SearchUser");
        if (InputSearch.value.trim() != "") {
            fetch("/SearchUserBy", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "type": type_search,
                        "request": InputSearch.value.trim()
                    }),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.sucess) {
                        const users = result.userlist;
                        UserBox.innerHTML = "";
                        users.forEach(user => {
                            if (user.photo === null) {
                                user.photo = localStorage.getItem("avatar");
                            }
                            UserBox.innerHTML += `
                        <div class=${'User'}>
                            <img src="${user.photo}" class=${'useravatar'} alt="${0} ">
                            <b class=${'username'} id=${user.id}>${user.name}</b> 
                        </div>
                    `;
                        });
                    } else {
                        let name = "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
                        let photo = localStorage.getItem("notfind");
                        let id = "errorfind";
                        UserBox.innerHTML = `
                        <div class=${'User'}>
                            <img src="${photo}" class=${'useravatar'} alt="${0} ">
                            <b class=${'username'} id=${id}>${name}</b> 
                        </div>
                    `;
                    }

                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
                });
        }
    }

    document.getElementById('SearchUser').addEventListener('click', function(event) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É —Å –∫–ª–∞—Å—Å–æ–º User –∏–ª–∏ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
        const userElement = event.target.closest('.User');
        if (userElement) {
            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ User
            const username = userElement.querySelector('.username');
            const userAvatar = userElement.querySelector('.useravatar');
            const userId = username.id;
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏
            if (userId !== "errorfind") {
                CreateChat(userId, userElement);

            }
        }
    });

    function CreateChat(userId, element) {
        //console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID: ${userId}`);
        document.getElementById("MainChatCreator").style.display = "flex";
        fetch("/GetUserInfo", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": userId
                }),
            })
            .then(response => response.json())
            .then(result => {
                console.log(result.photo);
                document.getElementById("usname").innerText = `–í—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å ${result.name}`;
                if (result.photo) {
                    result.photo = localStorage.getItem("avatar")
                }
                document.getElementById("user_ava").src = result.photo;
                document.querySelectorAll(".betta p").forEach(p => {
                    if (p.textContent.trim().includes("–ò–º—è")) {
                        p.textContent = `–ò–º—è: ${result.name}`;
                    } else if (p.textContent.trim().includes("–¢–µ–ª–µ—Ñ–æ–Ω")) {
                        p.textContent = `–¢–µ–ª–µ—Ñ–æ–Ω: ${result.phone}`;
                    }
                    if (p.textContent.trim().includes("ID")) {
                        p.textContent = `ID: ${result.id}`;
                    }
                });
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
            });
    }

    document.getElementById("cancel").addEventListener("click", function(e) {
        document.getElementById("MainChatCreator").style.display = "none";
    });

    document.getElementById("exit").addEventListener("click", function(e) {
        const res = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ?")
        if (res) {
            localStorage.clear();
            window.close();
            window.location.href = '';
            return true;
        };
    });
    document.getElementById("deletemyacc").addEventListener("click", function(e) {
        document.getElementById("red").style.display = "flex";
        document.querySelectorAll(".deletebox").forEach(e => {
            e.style.display = "flex";
        });
    });

    document.getElementById("yesdelete").addEventListener("click", function(e) {
        document.querySelectorAll(".deletebox").forEach(e => {
            e.style.display = "none";
        });
        document.querySelectorAll(".why").forEach(e => {
            e.style.display = "flex";
        });
    });
    document.querySelectorAll(".no").forEach(e => {
        e.addEventListener("click", function(i) {
            document.getElementById("red").style.display = "none";
            document.querySelectorAll(".why").forEach(e => {
                e.style.display = "none";
            });
        })
    })

    document.getElementById("yesdelete2").addEventListener("click", function(e) {
        let tx = document.getElementById("txa").value.trim();
        fetch("/Delete", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: DataUser,
                    why: tx
                }),
            })
            .then(response => response.json())
            .then(result => {
                if (result.sucess) {
                    alert("–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω");
                    window.localStorage.clear();
                    window.location.href = "";
                } else {
                    alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞");
                    document.getElementById("red").style.display = "none";
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
            });
    })
    document.getElementById("profil").addEventListener("click", function(e) {
        document.querySelectorAll(".MainCreateProfil").forEach(e => {
            e.style.display = "flex"
        });
    });
    document.getElementById("prof_canc").addEventListener("click", function(e) {
        document.querySelectorAll(".MainCreateProfil").forEach(e => {
            e.style.display = "none"
        });
    });
</script>
</body>

</html>