<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIN Messenger - –°–≤–æ–±–æ–¥—É —Å–ª–æ–≤—É!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style2.css') }}">
</head>

<body>
    <div class="background-container">
        <img id="fon" src="" alt="–§–æ–Ω" class="background-image">

    </div>

    <div class="shapes">
        <div id="searchblock">
            <input id="inputsearchuser">
            <button class="zzz" id="buttonsearch">Search By</button>
            <div class="by">
                <a class="zzz" href="#">Name</a>
                <a class="zzz" href="#">Phone</a>
                <a class="zzz" href="#" color="red">Id</a>
            </div>
        </div>

        <div class="optionsblock">
            <div class="swimopt">
                <button id="optionsbtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <div class="optionsmenu">
                    <a id="profil" href="#">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <a id="exit" href="#">–í—ã–π—Ç–∏</a>
                    <a id="deletemyacc" href="#" color="red">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
                </div>
            </div>
        </div>
    </div>


    <div class="mesenger_body">
        <div id="chatbox">
        </div>
        <div class="chat">
            <div class="input_msg">
                <input id="input_message">
                <button id="send_btn">Send</button>
            </div>
        </div>
    </div>

    <div id="SearchUser">
    </div>

    <div id="MainChatCreator">
        <div class="WhatCreate">
            <p id="usname">–í—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å </p>
            <div class="formdata">
                <div>
                    <img src="" id="user_ava" alt="0">
                </div>
                <div class="betta">
                    <p>–ò–º—è</p>
                    <p>–¢–µ–ª–µ—Ñ–æ–Ω</p>
                    <p>ID</p>
                </div>
            </div>
            <p>–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</p>
            <div id="about_user">
                <p class="long-text">–ù–µ —É–∫–∞–∑–∞–Ω–æ</p>
            </div>
            <div class="button_box">
                <button class="cancel_class" id="cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="createchatbtn_class" id="create_chatbtn">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
            </div>
        </div>
    </div>
    <div style="display: none;" id="red">
        <div class="deletebox">
            <p style="font-size: 27px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</p>
            <p style="font-size: 15px; margin:4px; justify-self: center;">–≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã</p>
            <div class="button_box2">
                <button class="no" id="nodelete">–ù–µ—Ç</button>
                <button class="yes" id="yesdelete">–î–∞</button>
            </div>
        </div>
        <div style="display: none;" class="why">
            <p style="font-size: 22px;">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —Ä–µ—à–∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
            <textarea id="txa" class="inpwhy"></textarea>
            <div class="button_box2">
                <button class="no" id="nodelete">–û—Ç–º–µ–Ω–∞</button>
                <button class="yes" id="yesdelete2">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div style="display: none;" class="MainCreateProfil">
        <div class="CreateProfil">
            <p style="font-size: 30px; margin-bottom: 6px; margin-top:7px">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</p>
            <div class="photo-container" style="position: relative; display: inline-block;">
                <img id="my_photo" src="">
                <!-- –ò–∫–æ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
                <div class="photo-add" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <span style="color: white; font-size: 18px;">+</span>
                </div>
                <!-- –ò–∫–æ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
                <div class="photo-delete" style="position: absolute; top: 5px; left: 5px; background: rgba(255,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; display: none;">
                    <span style="color: white; font-size: 18px;">√ó</span>
                </div>
            </div>
            <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
            <input type="file" id="photo_upload" accept="image/*" style="display: none;">
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–ò–º—è:</p>
                <input id="Name_input">
            </div>
            <div class="pol">
                <p style="margin-right: 35px; font-size:22px">–ü–æ–ª:</p>
                <input id="MaleCheck" class="chek" type="checkbox">
                <p style="margin-right: 28px; margin-left:3px">–ú—É–∂.</p>
                <input id="FemaleChack" class="chek" type="checkbox">
                <p style="padding-left: 3px;">–ñ–µ–Ω.</p>
            </div>
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–í–æ–∑—Ä–∞—Å—Ç:</p>
                <input id="AgeINP" type="number">
            </div>
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–¢–µ–ª–µ—Ñ–æ–Ω:</p>
                <input id="PhoneINP" type="number">
            </div>
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–î–†:</p>
                <input id="DR" type="date">
            </div>
            <p>–°–≤–æ—ë</p>
            <textarea id="AboutMe" style="min-height: 30px;"></textarea>
            <div class="btnboxprof">
                <button id="prof_canc">–û—Ç–º–µ–Ω–∞</button>
                <button id="prof_save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

</body>
<script>
    const photoContainer = document.querySelector('.photo-container');
    const photoAdd = document.querySelector('.photo-add');
    const photoDelete = document.querySelector('.photo-delete');
    const photoUpload = document.getElementById('photo_upload');
    const myPhoto = document.getElementById('my_photo');
    const DataUser = localStorage.getItem('Userdata');
    if (DataUser) {
        const Data = JSON.parse(DataUser);
        //console.log(Data)
        const delay = 1;
        if (true) {
            console.log("ppp")
            if (navigator.onLine) {
                const result = confirmIdentity(Data.email, Data.privatekey, Data.device, {
                    x: "auth"
                });
                console.log(result);
                if (result.result === false && result.what == "server") {
                    console.error("–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
                    delay++;
                    if (delay > 25) {
                        delay = 25;
                    }
                    setTimeout(() => {}, 1000 * delay)
                }
                if (result.result === false && result.what == "auth") {
                    alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
                    localStorage.removeItem("Userdata");
                    window.location.href = "/";
                }
                if (result.result === true) {
                    console.log('üéâ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');

                }
            }

        }

    } else {
        window.location.href = '/';

    }



    // –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - —Ç–æ–ª—å–∫–æ fetch –∏ then
    const images = [{
        name: 'avatar',
        url: '/static/images/Uniknown.png'
    }, {
        name: 'logo',
        url: '/static/images/logo.png'
    }, {
        name: "notfind",
        url: "static/images/notfind.png"
    }, {
        name: 'fone',
        url: "{{ url_for('static', filename='images/bgmes.jpg') }}"
    }];

    function loadAllImages() {
        images.forEach(image => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤ localStorage
            const saved = localStorage.getItem(image.name);

            if (saved) {
                // –£–∂–µ –µ—Å—Ç—å - –∏—Å–ø–æ–ª—å–∑—É–µ–º
                console.log(`‚úÖ ${image.name} - –∏–∑ –∫—ç—à–∞`);

            } else {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é
                console.log(`üì• ${image.name} - –∑–∞–≥—Ä—É–∂–∞–µ–º...`);

                fetch(image.url)
                    .then(response => response.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onload = function() {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                            localStorage.setItem(image.name, this.result);
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                            console.log(`‚úÖ ${image.name} - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`);
                        };
                        reader.readAsDataURL(blob);
                    })
                    .catch(error => {
                        console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${image.name}:`, error);
                    });
            }
        });
    }

    loadAllImages();
    const Data = JSON.parse(DataUser);
    document.getElementById("fon").src = localStorage.getItem("fone");
    const ChatBox = document.getElementById("chatbox")

    const device_id = Data.email;
    console.log("wss://" + window.location.hostname + ":8000/ws?device_id=" + device_id)
    const ws = new WebSocket(
        "wss://" + window.location.hostname + ":8000/ws?device_id=" + device_id
    );

    ws.onopen = () => {
        console.log("WebSocket connected");
    };

    ws.onmessage = (event) => {
        console.log("Received:", event.data);
    };

    ws.onclose = () => {
        console.log("WebSocket closed");
    };


    ChatBox.innerHTML = '';
    fetch("/userchatlist", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: JSON.parse(localStorage.getItem("Userdata")).email
            }),
        })
        .then(response => response.json())
        .then(result => {
            const chats = result.chats;
            chats.forEach(chat => {
                ChatBox.innerHTML += `
                <div class=${'chatinfo'}>
                    <img src="${chat.avatar}" class=${'chat-avatar'} alt="${0} ">
                    <b class=${'chat-name'}>${chat.name}</b> 
                </div>
            `;
            });

        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
        });
    document.getElementById("inputsearchuser").addEventListener("focus", function() {
        document.querySelector("#SearchUser").style.display = "flex";
    });
    document.getElementById("inputsearchuser").addEventListener("blur", function() {
        document.querySelector("#SearchUser").style.display = "none";
    });



    const button = document.getElementById('buttonsearch');
    const menu = document.querySelector('.by');
    const InputSearch = document.getElementById("inputsearchuser");
    let timeout;

    function showMenu() {
        const rect = button.getBoundingClientRect();
        menu.style.display = 'flex';
        menu.style.position = 'absolute';
        menu.style.top = (rect.bottom + 2) + 'px';
        menu.style.left = rect.left + 'px';
        menu.style.minWidth = rect.width + 'px';

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        setTimeout(() => menu.classList.add('show'), 10);
        clearTimeout(timeout);
    }

    function hideMenu() {
        menu.classList.remove('show');
        timeout = setTimeout(() => {
            menu.style.display = 'none';
        }, 200); // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
    }

    button.addEventListener('mouseenter', showMenu);
    button.addEventListener('mouseleave', hideMenu);

    menu.addEventListener('mouseenter', function() {
        clearTimeout(timeout);
        menu.classList.add('show');
    });

    menu.addEventListener('mouseleave', hideMenu);

    const menuLinks = document.querySelectorAll('.by a');

    menuLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ

            const linkText = this.textContent;
            console.log(`–ù–∞–∂–∞—Ç–∞ —Å—Å—ã–ª–∫–∞: ${linkText}`);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ —Å—Å—ã–ª–∫–∞ –Ω–∞–∂–∞—Ç–∞
            switch (linkText) {
                case 'Name':
                    SearchBy("name");
                    break;
                case 'Phone':
                    SearchBy("phone");
                    break;
                case 'Id':
                    SearchBy("id");
                    break;
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
            this.closest('.by').style.display = 'none';
            document.querySelector("#SearchUser").style.display = "flex";
        });
    });
    document.addEventListener("click", function(e) {
        if (e.target.className !== "zzz") {
            document.querySelector("#SearchUser").style.display = "none";
        }
    })

    function SearchBy(type_search) {
        //console.log('–í—ã–±—Ä–∞–Ω –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ ${}');
        // –í–∞—à –∫–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∏–º–µ–Ω–∏
        UserBox = document.getElementById("SearchUser");
        if (InputSearch.value.trim() != "") {
            fetch("/SearchUserBy", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "type": type_search,
                        "request": InputSearch.value.trim()
                    }),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.sucess) {
                        const users = result.userlist;
                        UserBox.innerHTML = "";
                        users.forEach(user => {
                            if (user.photo === null) {
                                user.photo = localStorage.getItem("avatar");
                            }
                            UserBox.innerHTML += `
                        <div class=${'User'}>
                            <img src="${user.photo}" class=${'useravatar'} alt="${0} ">
                            <b class=${'username'} id=${user.id}>${user.name}</b> 
                        </div>
                    `;
                        });
                    } else {
                        let name = "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
                        let photo = localStorage.getItem("notfind");
                        let id = "errorfind";
                        UserBox.innerHTML = `
                        <div class=${'User'}>
                            <img src="${photo}" class=${'useravatar'} alt="${0} ">
                            <b class=${'username'} id=${id}>${name}</b> 
                        </div>
                    `;
                    }

                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
                });
        }
    }

    document.getElementById('SearchUser').addEventListener('click', function(event) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É —Å –∫–ª–∞—Å—Å–æ–º User –∏–ª–∏ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
        const userElement = event.target.closest('.User');
        if (userElement) {
            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ User
            const username = userElement.querySelector('.username');
            const userAvatar = userElement.querySelector('.useravatar');
            const userId = username.id;
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏
            if (userId !== "errorfind") {
                CreateChat(userId, userElement);

            }
        }
    });

    function CreateChat(userId, element) {
        //console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID: ${userId}`);
        document.getElementById("MainChatCreator").style.display = "flex";
        fetch("/GetUserInfo", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": userId
                }),
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById("usname").innerText = `–í—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å ${result.name}`;
                if (result.photo) {
                    result.photo = result.photo
                } else {
                    result.photo = localStorage.getItem("avatar")
                }
                document.getElementById("user_ava").src = result.photo;
                document.querySelectorAll(".betta p").forEach(p => {
                    if (p.textContent.trim().includes("–ò–º—è")) {
                        p.textContent = `–ò–º—è: ${result.name}`;
                    } else if (p.textContent.trim().includes("–¢–µ–ª–µ—Ñ–æ–Ω")) {
                        p.textContent = `–¢–µ–ª–µ—Ñ–æ–Ω: ${result.phone}`;
                    }
                    if (p.textContent.trim().includes("ID")) {
                        p.textContent = `ID: ${result.id}`;
                    }
                });
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
            });
    }

    document.getElementById("cancel").addEventListener("click", function(e) {
        document.getElementById("MainChatCreator").style.display = "none";
    });

    document.getElementById("exit").addEventListener("click", function(e) {
        const res = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ?")
        if (res) {
            localStorage.clear();
            window.close();
            window.location.href = '';
            return true;
        };
    });
    document.getElementById("deletemyacc").addEventListener("click", function(e) {
        document.getElementById("red").style.display = "flex";
        document.querySelectorAll(".deletebox").forEach(e => {
            e.style.display = "flex";
        });
    });

    document.getElementById("yesdelete").addEventListener("click", function(e) {
        document.querySelectorAll(".deletebox").forEach(e => {
            e.style.display = "none";
        });
        document.querySelectorAll(".why").forEach(e => {
            e.style.display = "flex";
        });
    });
    document.querySelectorAll(".no").forEach(e => {
        e.addEventListener("click", function(i) {
            document.getElementById("red").style.display = "none";
            document.querySelectorAll(".why").forEach(e => {
                e.style.display = "none";
            });
        })
    })


    document.getElementById("yesdelete2").addEventListener("click", function(e) {
        let tx = document.getElementById("txa").value.trim();
        const Data = JSON.parse(localStorage.getItem("Userdata"));
        const result = confirmIdentity(Data.email, Data.privatekey, Data.device, {
            x: "del",
            "why": tx
        });
        console.log(result);
        if (result.success === false && result.what == "server") {
            alert("–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
        }
        if (result.success === false && result.what == "auth") {
            alert("–û—à–∏–±–∫–∞ –∞—É—Ç–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –±—É–¥–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞");
        }
        if (result.success === true) {
            console.log('üéâ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            localStorage.removeItem("Userdata");
            window.location.herf = "/";
        }

    });

    const maleCheck = document.getElementById('MaleCheck');
    const femaleCheck = document.getElementById('FemaleChack');

    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    maleCheck.addEventListener('change', function() {
        if (this.checked) {
            femaleCheck.checked = false;
        }
    });

    femaleCheck.addEventListener('change', function() {
        if (this.checked) {
            maleCheck.checked = false;
        }
    });


    document.getElementById("profil").addEventListener("click", function(e) {
        document.querySelectorAll(".MainCreateProfil").forEach(e => {
            e.style.display = "flex"
            fetch("/GetUserInfo", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: JSON.parse(localStorage.getItem("Userdata")).email
                    }),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.photo === null) {
                        result.photo = localStorage.getItem("avatar");
                    }
                    if (result.phone !== null) {
                        document.getElementById("PhoneINP").value = result.phone
                    }
                    if (result.age !== null) {
                        document.getElementById("AgeINP").value = result.age;
                    }
                    if (result.DR !== null) {
                        document.getElementById("DR").value = result.DR;
                    }
                    if (result.pol !== null) {
                        switch (result.pol) {
                            case "–ú—É–∂":
                                maleCheck.checked = true;
                            case "–ñ–µ–Ω":
                                femaleCheck.checked = true;
                        }
                    }
                    document.getElementById("my_photo").src = result.photo;
                    document.getElementById("Name_input").value = result.name;
                })
                .catch(error => {
                    console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
                });
        });
    });

    document.getElementById("prof_canc").addEventListener("click", function(e) {
        document.querySelectorAll(".MainCreateProfil").forEach(e => {
            e.style.display = "none";
        });
    });

    document.getElementById("prof_save").addEventListener("click", async function(e) {
        const strg = JSON.parse(localStorage.getItem("Userdata"));
        let pol = "–Ω–µ —É–∫–∞–∑–∞–Ω–æ";
        if (maleCheck.checked) {
            pol = "–ú—É–∂";
        }
        if (femaleCheck.checked) {
            pol = "–ñ–µ–Ω";
        }

        // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ –¥–∞–Ω–Ω—ã–µ - –í–ê–ñ–ù–û: await!
        const ph = await getProfilePhotoData();

        const about = {
            name: document.getElementById("Name_input").value,
            phone: document.getElementById("PhoneINP").value,
            age: document.getElementById("AgeINP").value,
            DR: document.getElementById("DR").value,
            pol: pol,
            dopinf: document.getElementById("AboutMe").value,
            photo: ph // base64 —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null
        }
        console.log(about);
        // –î–æ–±–∞–≤–ª—è–µ–º await –¥–ª—è confirmIdentity
        const result = await confirmIdentity(strg.email, strg.privatekey, strg.device, {
            x: "prof",
            data: about
        });

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (result.result === true) {
            console.log('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            document.querySelector('.MainCreateProfil').style.display = 'none';
        }
        if (result.result === false && result.what === "auth") {
            alert('–û—à–∏–±–∫–∞ –∞—É—Ç–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            document.querySelector('.MainCreateProfil').style.display = 'none';
        }
        if (result.result === false && result.what === "server") {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            document.querySelector('.MainCreateProfil').style.display = 'none';
        }
    });

    let currentPhotoFile = null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ "+" - –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫
    photoAdd.addEventListener('click', function(e) {
        e.preventDefault();
        photoUpload.click();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    photoUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                return;
            }

            currentPhotoFile = file;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            const reader = new FileReader();
            reader.onload = function(e) {
                myPhoto.src = e.target.result;
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                photoDelete.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–æ—Ä–∑–∏–Ω—É - —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
    photoDelete.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
        myPhoto.src = localStorage.getItem("avatar");
        currentPhotoFile = null;
        photoUpload.value = '';

        // –°–∫—Ä—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É —É–¥–∞–ª–µ–Ω–∏—è
        photoDelete.style.display = 'none';
    });

    // Drag and Drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    photoContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        photoContainer.style.borderColor = '#007bff';
    });

    photoContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        photoContainer.style.borderColor = '#ccc';
    });

    photoContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        photoContainer.style.borderColor = '#ccc';

        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            if (file.size > 5 * 1024 * 1024) {
                alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                return;
            }

            currentPhotoFile = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                myPhoto.src = e.target.result;
                photoDelete.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
    });


    function loadExistingPhoto(photoBase64) {
        if (photoBase64) {
            myPhoto.src = photoBase64;
            photoDelete.style.display = 'flex';
            currentPhotoFile = null; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ–º base64
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
    function getProfilePhotoData() {
        if (currentPhotoFile) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç base64
                };
                reader.readAsDataURL(currentPhotoFile);
            });
        }
        return Promise.resolve(null);
    }

    async function confirmIdentity(email, privateKey, device_name, purpose = 'auth') {
        try {
            //console.log(`üîê –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è: ${email}`);
            const challengeResponse = await fetch("/challenge", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    what: purpose
                })
            });
            const challengeResult = await challengeResponse.json();
            if (!challengeResult.success) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å challenge');
                return {
                    result: false,
                    what: "server"
                };
            }
            const challenge = challengeResult.challenge;
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω challenge –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
            const signature = await signChallenge(challenge, privateKey);
            const verifyResponse = await fetch("/podpis", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    challenge: challenge,
                    signature: signature,
                    device: device_name,
                    what: purpose
                })
            });

            const verifyResult = await verifyResponse.json();

            if (verifyResult.success) {
                console.log('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                return {
                    result: true,
                    what: "auth"
                };
            } else {
                console.log('‚ùå –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', verifyResult.error);
                return {
                    result: false,
                    what: "auth"
                };
            }

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', error);
            return {
                result: false,
                what: "server"
            };
        }
    }


    function cleanPrivateKey(privateKeyData) {
        //console.log('üîß –û—á–∏—â–∞—é –∫–ª—é—á...');
        if (privateKeyData.includes('-----BEGIN')) {
            //console.log('üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω PEM —Ñ–æ—Ä–º–∞—Ç');
            return privateKeyData
                .replace(/-----BEGIN PRIVATE KEY-----/g, '')
                .replace(/-----END PRIVATE KEY-----/g, '')
                .replace(/-----BEGIN RSA PRIVATE KEY-----/g, '')
                .replace(/-----END RSA PRIVATE KEY-----/g, '')
                .replace(/\s/g, ''); // –£–±–∏—Ä–∞–µ–º –í–°–ï –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã
        }
        return privateKeyData.replace(/\s/g, '');
    }

    // üîß –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø - –ø–æ–¥–ø–∏—Å—å challenge
    async function signChallenge(challenge, privateKeyData) {
        try {
            //console.log('‚úçÔ∏è –ù–∞—á–∏–Ω–∞—é –ø–æ–¥–ø–∏—Å—å challenge...');
            //console.log('–î–ª–∏–Ω–∞ –∫–ª—é—á–∞ –¥–æ –æ—á–∏—Å—Ç–∫–∏:', privateKeyData.length);
            // 1. –û—á–∏—â–∞–µ–º –∫–ª—é—á –æ—Ç PEM –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –ø—Ä–æ–±–µ–ª–æ–≤
            const privateKeyB64 = cleanPrivateKey(privateKeyData);
            //console.log('–î–ª–∏–Ω–∞ –∫–ª—é—á–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:', privateKeyB64.length);
            //console.log('–ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞:', privateKeyB64.substring(0, 50));
            // 2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
            const privateKey = await importPrivateKey(privateKeyB64);
            // 3. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º challenge
            const signature = await crypto.subtle.sign({
                    name: "RSA-PSS",
                    saltLength: 32
                },
                privateKey,
                new TextEncoder().encode(challenge)
            );
            // 4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
            const signatureB64 = arrayBufferToBase64(signature);
            //console.log('‚úÖ Challenge –ø–æ–¥–ø–∏—Å–∞–Ω! –î–ª–∏–Ω–∞ –ø–æ–¥–ø–∏—Å–∏:', signatureB64.length);
            return signatureB64;

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤ signChallenge:', error);
            throw error;
        }
    }

    // üîß –û–°–¢–ê–í–¨ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
    async function importPrivateKey(privateKeyB64) {
        try {
            //console.log('üîë –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é –∫–ª—é—á...');
            const binaryString = atob(privateKeyB64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const privateKey = await crypto.subtle.importKey(
                "pkcs8",
                bytes, {
                    name: "RSA-PSS",
                    hash: {
                        name: "SHA-256"
                    }
                },
                true, ["sign"]
            );
            //console.log('‚úÖ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
            return privateKey;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–ª—é—á–∞:', error);
            throw error;
        }
    }

    function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }
</script>
</body>

</html>