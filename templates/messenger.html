<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIN Messenger - –°–≤–æ–±–æ–¥—É —Å–ª–æ–≤—É!</title>
    <link rel="stylesheet" href="static/css/style22.css">
</head>
<style src="static/css/style2.css"></style>
<body>
    <div class="background-container">
        <img id="fon" src="" alt="–§–æ–Ω" class="background-image">
    </div>

    <div class="shapes">
        <div id="searchblock">
            <input id="inputsearchuser">
            <button class="zzz" id="buttonsearch">Search By</button>
            <div class="by">
                <a class="zzz" href="#">Name</a>
                <a class="zzz" href="#">Phone</a>
                <a class="zzz" href="#" color="red">Id</a>
            </div>
        </div>

        <div class="optionsblock">
            <div class="swimopt">
                <button id="optionsbtn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <div class="optionsmenu">
                    <a id="profil" href="#">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <a id="exit" href="#">–í—ã–π—Ç–∏</a>
                    <a id="deletemyacc" href="#" color="red">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
                </div>
            </div>
        </div>
    </div>


    <div class="mesenger_body">
        <div id="chatbox"></div>
        <div class="wind">
            <div id="chatshape">
                <button id="shapebackbtn" style="padding: 0px;">‚¨ÖÔ∏è</button>
                <img id="shapechatavatar" style="width: 40px; height:40px" class="chat-avatar">
                <p id="shapechatname"></p>
                <button id="delchat">üóëÔ∏è</button>
            </div>
            <div id="chat">

            </div>
            <div class="input_msg">
                <textarea id="input_message"></textarea>
                <button id="send">Send</button>
                <button id="sendmedia" class="microphone" style="        background-color: black;
                border: 1px solid white;
                border-radius: 25px;
                font-size: 22px;
                padding: 4px;">üéôÔ∏è</button>
            </div>
        </div>
    </div>

    <div id="SearchUser">
    </div>

    <div id="MainChatCreator">
        <div class="WhatCreate">
            <p id="usname">–í—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å </p>
            <div class="formdata">
                <div>
                    <img src="" id="user_ava" alt="0">
                </div>
                <div class="betta">
                    <p>–ò–º—è</p>
                    <p>–¢–µ–ª–µ—Ñ–æ–Ω</p>
                    <p>ID</p>
                </div>
            </div>
            <p>–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</p>
            <div id="about_user">
                <p class="long-text">–ù–µ —É–∫–∞–∑–∞–Ω–æ</p>
            </div>
            <div class="button_box">
                <button class="cancel_class" id="cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="createchatbtn_class" id="create_chatbtn">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
            </div>
        </div>
    </div>
    <div style="display: none;" id="red">
        <div class="deletebox">
            <p style="font-size: 27px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</p>
            <p style="font-size: 15px; margin:4px; justify-self: center;">–≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã</p>
            <div class="button_box2">
                <button class="no" id="nodelete">–ù–µ—Ç</button>
                <button class="yes" id="yesdelete">–î–∞</button>
            </div>
        </div>
        <div style="display: none;" class="why">
            <p style="font-size: 22px;">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π —Ä–µ—à–∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
            <textarea id="txa" class="inpwhy"></textarea>
            <div class="button_box2">
                <button class="no" id="nodelete">–û—Ç–º–µ–Ω–∞</button>
                <button class="yes" id="yesdelete2">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div style="display: none;" class="MainCreateProfil">
        <div class="CreateProfil">
            <p style="font-size: 30px; margin-bottom: 6px; margin-top:7px">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</p>
            <div class="photo-container" style="position: relative; display: inline-block;">
                <img id="my_photo" src="">
                <div class="photo-add" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    <span style="color: white; font-size: 18px;">+</span>
                </div>
                <div class="photo-delete" style="position: absolute; top: 5px; left: 5px; background: rgba(255,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; display: none;">
                    <span style="color: white; font-size: 18px;">√ó</span>
                </div>
            </div>
            <input type="file" id="photo_upload" accept="image/*" style="display: none;">
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–ò–º—è:</p>
                <input id="Name_input">
            </div>
            <div class="pol">
                <p style="margin-right: 35px; font-size:22px">–ü–æ–ª:</p>
                <input id="MaleCheck" class="chek" type="checkbox">
                <p style="margin-right: 28px; margin-left:3px">–ú—É–∂.</p>
                <input id="FemaleChack" class="chek" type="checkbox">
                <p style="padding-left: 3px;">–ñ–µ–Ω.</p>
            </div>
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–í–æ–∑—Ä–∞—Å—Ç:</p>
                <input id="AgeINP" type="number">
            </div>
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–¢–µ–ª–µ—Ñ–æ–Ω:</p>
                <input id="PhoneINP" type="number">
            </div>
            <div style="display: flex; align-items: center; margin:5px">
                <p style="font-size: 22px; margin-right: 10px">–î–†:</p>
                <input id="DR" type="date">
            </div>
            <p>–°–≤–æ—ë</p>
            <textarea id="AboutMe" style="min-height: 30px;"></textarea>
            <div class="btnboxprof">
                <button id="prof_canc">–û—Ç–º–µ–Ω–∞</button>
                <button id="prof_save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div style="display: none;" class="newdevice_black">
        <div class="newdevice">
            <p style="font-size: 30px;">–ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ö–æ—á–µ—Ç –≤–æ–π—Ç–∏</p>
            <button id="pdp">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        </div>

        <div style="display: flex;" class="more">
            <p id="moreinfo"></p>
            <div class="btnboxauth">
                <button style="margin-right: 15px; font-size: 22px;" class="no" id="yesi">–î–∞ —ç—Ç–æ —è</button>
                <button style="margin-left: 15px; font-size: 22px;" class="yes" id="noi">–ù–µ—Ç –Ω–µ —è</button>
            </div>
        </div>
    </div>

    <div id="imageOverlay" class="image-overlay hidden">
        <div class="image-card">
            <img id="imagePreview" />
            <div class="image-actions">
                <button id="cancelImage">‚úñ</button>
                <button id="sendImage">‚û§</button>
            </div>
        </div>
    </div>
    <div id="msgMenu" class="hidden_m">
        <button id="editMsg">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button id="deleteMsg">–£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <div id="recordModal" class="hidden_md">
        <div class="record-box">
            <div id="recordTime">00:00</div>
            <button id="stopRec">–°—Ç–æ–ø</button>
        </div>
    </div>
</body>
<script src="/static/js/appCrypto.js"></script>
<script src="static/js/MessagesDB_3.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', async function() {
        class Graphic {
            constructor(chatElement) {
                this.chat = chatElement;
                this.loading = false;
            }

            _createMessage(msg) {
                console.log(msg)
                const div = document.createElement("div");
                div.className = msg.classname
                if (msg.type !== "tmc"){
                    div.dataset.id = msg.id;
                    const user = document.createElement("p");
                    user.className = "name";
                    user.textContent = msg.namesender;
                    console.log(msg.type)
                    if (msg.type === "txt"){
                        var text = document.createElement("p");
                        text.className = "text";
                        text.textContent = msg.content;
                    }
                    if (msg.type === "img"){
                        var text = document.createElement("img");
                        text.src = msg.content;
                    }
                    if (msg.type === "voice"){
                        var text = document.createElement("audio");
                        text.style.maxHeight="35px"
                        text.style.maxWidth="250px"
                        text.controls=true;
                        text.src = URL.createObjectURL(msg.content);
                    }
                    const data_t = document.createElement("p");
                    data_t.className = "time";
                    data_t.textContent = msg.time;
                    div.append(user, text, data_t);
                    return div;
                }
                else{
                    div.className = "message-center"; 
                    const text = document.createElement("p");
                    text.textContent = msg.content;
                    div.append()
                }
            }

            add(msg) {
                const el = this._createMessage(msg);
                this.chat.appendChild(el);
                this.chat.scrollTop = this.chat.scrollHeight;
            }

            prepend(msg) {
                const el = this._createMessage(msg);
                this.chat.prepend(el);
                this.chat.scrollTop = this.chat.scrollHeight;
            }

            update(id, msg) {
                const el = this.chat.querySelector(`[data-id="${id}"]`);
                if (!el) return;
                if (msg.type === "txt"){
                    el.querySelector(".text").textContent = newcontent;
                }
                if (msg.type === "img" || msg.type === "voice"){
                    el.querySelector(".text").src = newcontent;
                }
            }

            remove(id) {
                const el = this.chat.querySelector(`[data-id="${id}"]`);
                if (!el) return;

                el.remove();
            }

            prepend(messages) {
                if (!messages.length) return;

                const oldHeight = this.chat.scrollHeight;

                for (const msg of messages) {
                    const el = this._createMessage(msg);
                    this.chat.prepend(el);
                }

                const newHeight = this.chat.scrollHeight;
                this.chat.scrollTop += (newHeight - oldHeight);
            }
        }
        //localStorage.clear();
        var CurrentChat = null;
        var UnCookMessages = {};
        var lastDate = null;
        try {
            var ChatsData = JSON.parse(localStorage.getItem("Chats"));
        } catch {
            localStorage.setItem("Chats", JSON.stringify({}));
            var ChatsData = {};
        }
        try {
            var UserNames = JSON.parse(localStorage.getItem("UserNames"));
            if (UserNames === null) {
                UserNames = {};
            }
        } catch {
            localStorage.setItem("UserNames", JSON.stringify({}));
            var UserNames = {};
        }
        const messagedb = new MessageStore();
        await messagedb.open();
        const GraphicChat = document.getElementById("chat");
        const graphic = new Graphic(document.getElementById("chat"));
        const photoContainer = document.querySelector('.photo-container');
        const photoAdd = document.querySelector('.photo-add');
        const photoDelete = document.querySelector('.photo-delete');
        const photoUpload = document.getElementById('photo_upload');
        const myPhoto = document.getElementById('my_photo');
        const DataUser = localStorage.getItem('Userdata');
        const Data = JSON.parse(DataUser);
        const ChatBox = document.getElementById("chatbox");
        const msg_menu = document.getElementById("msgMenu");
        const mediabtn = document.getElementById("sendmedia")
        msg_menu.classList.remove("hidden_m")
        var activeMessageId = null;
        var lastIdload = -1;
        const Month = {
            0: "—è–Ω–≤–∞—Ä—å",
            1: "—Ñ–µ–≤—Ä–∞–ª—å",
            2: "–º–∞—Ä—Ç",
            3: "–∞–ø—Ä–µ–ª—å",
            4: "–º–∞–π",
            5: "–∏—é–Ω—å",
            6: "–∏—é–ª—å",
            7: "–∞–≤–≥—É—Å—Ç",
            8: "—Å–µ–Ω—Ç—è–±—Ä—å",
            9: "–æ–∫—Ç—è–±—Ä—å",
            10: "–Ω–æ—è–±—Ä—å",
            11: "–¥–Ω–∫–∞–±—Ä—å"
        };
        var platform = "Unknown OS";
        if (navigator.appVersion.indexOf("Win") != -1)
            platform = "Windows";

        else if (navigator.appVersion.indexOf("Mac") != -1)
            platform = "MacOS";

        else if (navigator.appVersion.indexOf("android") != -1)
            platform = "android";

        else if (navigator.appVersion.indexOf("ios") != -1)
            platform = "ios";

        else if (navigator.appVersion.indexOf("Linux") != -1)
            platform = "Linux";
        else {
            platform = "Unknown OS";
        }

        if (DataUser) {
            const Data = JSON.parse(DataUser);
            console.log(Data);
            const delay = 1;

            const result = await confirmIdentity(Data.my_id, Data.device_id, Data.email, Data.privatekey, Data.device, {
                x: "auth"
            });
            console.log(result);
            if (result.result === false && result.what == "server") {
                console.error("–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
                delay++;
                if (delay > 25) {
                    delay = 25;
                }
                setTimeout(() => {}, 1000 * delay)
            }
            if (result.result === false && result.what == "auth") {
                alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
                localStorage.removeItem("Userdata");
                //window.location.href = "";
            }
            if (result.result === true) {
                console.log('üéâ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            }

        } else {
            window.location.href = '/';
        }

        const images = [{
            name: 'avatar',
            url: '/static/images/Uniknown.png'
        }, {
            name: 'logo',
            url: '/static/images/logo.png'
        }, {
            name: "notfind",
            url: "static/images/notfind.png"
        }, {
            name: 'fone',
            url: "static/images/bgmes.jpg"
        }, {
            name: 'UniknownChat2',
            url: 'static/images/UniknownChat.jpg'
        }];

        async function GetIPInfo(ip) {
            const url = `https://ipapi.co/${ip}/json/`;
            const data = await fetch(url).then(r => r.json());
            console.log(data);
            return data;
        }
        async function loadAllImages() {
            await images.forEach(image => {
                const saved = localStorage.getItem(image.name);
                if (saved) {
                    console.log(`‚úÖ ${image.name} - –∏–∑ –∫—ç—à–∞`);

                } else {
                    console.log(`üì• ${image.name} - –∑–∞–≥—Ä—É–∂–∞–µ–º...`);
                    fetch(image.url)
                        .then(response => response.blob())
                        .then(blob => {
                            const reader = new FileReader();
                            reader.onload = function() {
                                localStorage.setItem(image.name, this.result);
                                console.log(`‚úÖ ${image.name} - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`);
                            };
                            reader.readAsDataURL(blob);
                        })
                        .catch(error => {
                            console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${image.name}:`, error);
                        });
                }
            });
            return true;
        }

        loadAllImages().then(res => {
            document.getElementById("fon").src = localStorage.getItem("fone") || "static/images/bgmes.jpg";
        });
        LoadChats()

        async function askNotificationPermission() {
            const permission = await Notification.requestPermission();
            console.log("Notification permission:", permission);
        }

        async function UpdateGUI(msg) {
            if (ChatsData[CurrentChat].type !== "tehnic") {
                //console.log(deepJsonParse(msg.msg), ChatsData[parseInt(CurrentChat)].privatekeycrypt)
                var tag = false;
                var date = new Date(msg.created)
                if (!isSameDay(lastDate, date) && lastDate !== null) {
                    GraphicChat.innerHTML += `
                    <div class="message-center">
                        <p id="text">${Month[date.getMonth()]}, ${date.getDate()}</p>
                    </div>
                    `
                }
                //console.log(date,`${Month[date.getMonth()]}, ${date.getDate()}`,msg.created,msg)
                //console.log(deepJsonParse(msg.msg))
                //console.log( ChatsData[parseInt(CurrentChat)].privatekeycrypt)
                //console.log(await hybridDecrypt(deepJsonParse(msg.msg), ChatsData[parseInt(CurrentChat)].privatekeycrypt))
                lastDate = date;
                if (msg.datatype === "txt") {
                    var content = await hybridDecrypt(deepJsonParse(msg.msg), ChatsData[parseInt(CurrentChat)].privatekeycrypt)
                } else {
                    try{
                    var prepared = await prepareEncryptedPackage({
                        encryptedKeyPath: `/media/encrypted/${msg.id}.key`,
                        encryptedDataPath: `/media/encrypted/${msg.id}.bin`,
                        ivPath: `/media/encrypted/${msg.id}.iv`
                    })
                    var content = await decryptBlob(deepJsonParse(prepared), ChatsData[parseInt(CurrentChat)].privatekeycrypt)
                    }
                    catch{
                        return;
                    }
                }
                var name = "Uniknown"

                if (msg.user_id in UserNames) {
                    name = UserNames[msg.user_id]["name"]
                    console.log(name)
                } else {
                    name = await GetName(id = msg.user_id)
                    name = name["name"]
                    if (name !== null) {
                        UserNames[msg.user_id] = {
                            "name": name
                        }
                        localStorage.setItem("UserNames", UserNames)
                    }
                }

                if (msg.user_id === Data.my_id) {
                    name = "–í—ã";
                    tag = true
                }
            } else {
                var content = msg.msg
                var name = "MIN-help"
            }
            if (tag) {
                var classn = "message-right";
            } else {
                var classn = "message-left";
            }
            if (msg.datatype === "txt") {
                console.log(content)
                graphic.add({type: msg.datatype,
                    id: msg.id,
                    content: content,
                    time: `${date.getHours()}:${date.getMinutes()}`,
                    namesender: name,
                    classname: classn

                })
            }
            if (msg.datatype === "img" || msg.datatype === "voice") {
                console.log(content)
                if (msg.datatype==="img"){
                    var img = await convertImage(content)}
                else{
                    var img = content
                }
                console.log(img)
                graphic.add({type: msg.datatype,
                    id: msg.id,
                    content: img,
                    time: `${date.getHours()}:${date.getMinutes()}`,
                    namesender: name,
                    classname: classn
                })
            }

        }

        async function SavemyMsg(datae) {
            if (datae.success) {
                var msgencrypt_g = UnCookMessages[datae["uniknownid"]]
                await messagedb.save({
                    id: parseInt(datae.message_id),
                    internal_id: parseInt(datae.internal_id),
                    chat_id: parseInt(msgencrypt_g.chatid),
                    user_id: parseInt(msgencrypt_g.userid),
                    datatype: datae.typemsg,
                    msg: msgencrypt_g.message,
                    created: datae.datatime
                })
                delete UnCookMessages[datae["uniknownid"]];
            } else {
                console.log(datae)
                alert("–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")
            }
        }

        async function SaveMsg(datae) {
            await messagedb.save({
                id: parseInt(datae.message_id),
                internal_id: parseInt(datae.internal_id),
                chat_id: parseInt(datae.chat_id),
                user_id: parseInt(datae.user_id),
                datatype: datae.typemsg,
                msg: datae.message,
                created: datae.datatime
            })
        }

        askNotificationPermission();
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/static/js/sw.js")
                .then(() => console.log("SW registered"));
        }

        const device_id = Data.email + "|id" + Data.device_id;
        console.log(device_id)
        let pendingNotification = null;
        const ws = new WebSocket(
            "wss://" + window.location.hostname + ":443/ws?device_id=" + device_id
        );

        ws.onopen = () => {
            console.log("WebSocket connected");
            ws.send(JSON.stringify({
                type: "GetUnreadMsg",
                id: Data.my_id
            }))
            console.log(localStorage.getItem("Chats"))
        };

        ws.onmessage = async function(event) {
            const datae = JSON.parse(event.data)
            console.log(datae);
            if (datae.type === "newdevice") {
                localStorage.setItem("newdeviceadd", JSON.stringify({
                    d: datae.mydevice
                }))
                localStorage.setItem("new_public", JSON.stringify({
                    publickey: datae.publickey,
                    platform: datae.platform
                }));
                document.getElementById("moreinfo").innerText = "Loading device Info......"
                try {
                    document.getElementById("moreinfo").innerText = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ\n  ip: ${datae.ip}\n —Å—Ç—Ä–∞–Ω–∞: ${dataip.country_name}\n  Timezone: ${datae.device.timezone}\n  –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${0}\n  –Ø–∑—ã–∫: ${datae.device.language}\n  –¢–µ—Ö: ${datae.device.userAgent.replace(" ","\n")}\n –≠–∫—Ä–∞–Ω: ${datae.device.screen.width}x${datae.device.screen.height}  `
                    GetIPInfo(datae.ip).then(dataip => {
                        if (dataip === null) {
                            document.getElementById("moreinfo").innerText = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ\n  ip: ${datae.ip}\n  Timezone: ${datae.device.timezone}\n  –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${0}\n  –Ø–∑—ã–∫: ${datae.device.language}\n  –¢–µ—Ö: ${datae.device.userAgent.replace(" ","\n")}\n –≠–∫—Ä–∞–Ω: ${datae.device.screen.width}x${datae.device.screen.height}  `

                        }
                    })
                } catch {}
                if (document.hidden) {
                    pendingNotification = true;
                } else {
                    document.querySelectorAll(".newdevice_black").forEach(e => {
                        e.style.display = "flex";
                    });
                    document.querySelectorAll(".newdevice").forEach(e => {
                        e.style.display = "flex"
                        e.classList.add("run");
                    })
                }
            } else if (datae.type === "answnewchat") {
                switch (datae.success) {
                    case "error":
                        alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞")
                        break;
                    case "waiting":
                        alert(`–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–º–∏—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏–∏, —Ç–æ —á–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è —É –≤–∞—Å`)
                        break;
                }
            } else if (datae.type === "new_chat") { // –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
                console.log("call true func")
                CreateChat(flag = true, user = datae.user)
            } else if (datae.type === "addchat") { // –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è  - —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = sava chat 
                console.log(datae.chat)
                var jsonkey = deepJsonParse(datae.chat.privatekeycrypt.replace(/'/g, '"'))
                datae.chat.privatekeycrypt = await hybridDecrypt(jsonkey, Data.privatekeycrypt)
                console.log(datae.chat)
                ChatsData[datae.chat.id] = datae.chat
                localStorage.setItem("Chats", JSON.stringify(ChatsData));
                LoadChats();
                console.log(localStorage.getItem("Chats"))
            } else if (datae.type === "addmymsg") {
                SavemyMsg(datae)
            } else if (datae.type === "addmsg") {
                SaveMsg(datae)
                if (datae.chat_id === CurrentChat) {
                    var msg = {
                        msg: datae.message,
                        user_id: datae.user_id,
                        created: datae.datatime,
                        datatype: datae.typemsg
                    }
                    UpdateGUI(msg)
                }
            } else if (datae.type === "newunread") {
                for (let msg of datae.messages) {
                    console.log(msg)
                    messagedb.save({
                            id: parseInt(msg.id),
                            internal_id: parseInt(msg.internal_id),
                            chat_id: parseInt(msg.chat_id),
                            user_id: parseInt(msg.user_id),
                            datatype: msg.datatype,
                            msg: msg.content,
                            created: msg.created
                        })
                        // ws.send(JSON.stringify({
                        //     type: "readmsg",
                        //     id: msg.id
                        // }))
                }
            }
            try {
                navigator.serviceWorker.ready.then(reg => {
                    reg.active.postMessage({
                        type: "notify",
                        title: "–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
                        body: data.message || "–ï—Å—Ç—å —Å–æ–±—ã—Ç–∏–µ",
                        data: datae
                    });
                });
            } catch {

            }
        };

        ws.onclose = () => {
            console.log("WebSocket closed");
        };


        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && pendingNotification) {
                document.querySelectorAll(".newdevice_black").forEach(e => {
                    e.style.display = "flex";
                });
                document.querySelectorAll(".newdevice").forEach(e => {
                    e.style.display = "flex"
                    e.classList.add("run");
                })
                pendingNotification = null;
            }
        });


        document.getElementById("pdp").addEventListener("click", function() {
            document.querySelectorAll(".newdevice").forEach(e => {
                e.style.display = "none";
            })
            document.querySelectorAll(".more").forEach(e => {
                e.classList.add("run");
            })
        });

        document.getElementById("noi").addEventListener("click", function() {
            confirmIdentity(Data.my_id, Data.device_id, Data.email, Data.privatekey, Data.device, {
                x: "no_i_not"
            }).then(res => {
                console.log(res);
                if (res.result === true) {
                    document.querySelectorAll(".newdevice_black").forEach(e => {
                        e.style.display = "none";
                    });
                    document.querySelectorAll(".newdevice").forEach(e => {
                        e.style.display = "none";
                    })
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å —Å–µ—Ç—å—é!");
                }
            });
        })

        document.getElementById("yesi").addEventListener("click", function() {

            (async function() {
                let user = JSON.parse(localStorage.getItem("Userdata"));

                const keysencrypt = JSON.parse(localStorage.getItem("new_public"))
                const dts = JSON.stringify({
                    privatekey: user.privatekey,
                    privatekeycrypt: user.privatekeycrypt
                })
                let keys_shifr = await hybridEncrypt(dts, keysencrypt.publickey);

                let res = await confirmIdentity(Data.my_id, Data.device_id, Data.email, Data.privatekey, Data.device, {
                    x: "yes_i_my",
                    key: keys_shifr,
                    device: JSON.parse(localStorage.getItem("newdeviceadd")).d,
                    platform: keysencrypt.platform
                });

                if (res.result === true) {
                    document.querySelectorAll(".newdevice_black").forEach(e => {
                        e.style.display = "none";
                    });

                    document.querySelectorAll(".newdevice").forEach(e => {
                        e.style.display = "none";
                    });
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å —Å–µ—Ç—å—é!");
                }

            })();

        });

        function UpdataChats() {
            ChatBox.innerHTML = '';
            const chats = JSON.parse(localStorage.getItem("Chats"))
            for (var key of Object.keys(chats)) {
                var chat = chats[parseInt(key)]
                ChatBox.innerHTML += `
                <div data-chat-id=${'chat'+chat.id} class=${'chatinfo'}>
                    <img src="${chat.photo}" class=${'chat-avatar'} alt="${0} ">
                    <b class=${'chat-name'}>${chat.name}</b> 
                </div>
                `;
            };
        }

        async function LoadChats() {
            var localChats = JSON.parse(localStorage.getItem("Chats"))

            console.log(" loading chats...")
            console.log(localChats)
            ChatsData = {}
            const response = await fetch("/userchatlist", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: JSON.parse(localStorage.getItem("Userdata")).my_id
                }),
            });

            const chats = await response.json();
            console.log(chats)
            for (const chat of chats) {
                if (!chat.photo || chat.photo === "None") {
                    if (chat.type === "p2p") {
                        var id = chat.name.split("/")
                        console.log(chat)
                        if (String(id[0]) === String(Data.my_id)) {
                            id = id[1]
                        } else {
                            id = id[0]
                        }
                        var user = await GetUserInfo({
                            "id": id
                        })
                        chat.name = user.name;
                        chat.photo = user.photo;
                    } else {
                        chat.photo = localStorage.getItem("Uniknownchat2");
                    }
                } else {
                    chat.photo = await imageToBase64(chat.photo);
                }
                try {
                    console.log(localChats, localChats[parseInt(chat.id)])
                    chat.privatekeycrypt = localChats[parseInt(chat.id)].privatekeycrypt
                } catch {}
                ChatsData[parseInt(chat.id)] = chat
            }
            localStorage.setItem("Chats", JSON.stringify(ChatsData));
            UpdataChats();
        }

        document.getElementById("inputsearchuser").addEventListener("focus", function() {
            document.querySelector("#SearchUser").style.display = "flex";
        });
        document.getElementById("inputsearchuser").addEventListener("blur", function() {
            document.querySelector("#SearchUser").style.display = "none";
        });

        GraphicChat.addEventListener("scroll", async function ()  {
            // –í–ù–ò–ó
            if (GraphicChat.scrollTop + chat.clientHeight >= chat.scrollHeight - 5) {
                console.log("–ù–∏–∑ ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è");
                GraphicChat.firstElementChild
            }

            // –í–í–ï–†–•
            if (GraphicChat.scrollTop <= 5) {
                console.log("–í–µ—Ä—Ö ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è");
                if (parseInt(GraphicChat.firstElementChild.dataset.id) < lastIdload || lastIdload===-1){
                    var newmsgs = await messagedb.getChatMessages(chatId=parseInt(CurrentChat),5,parseInt(GraphicChat.firstElementChild.dataset.id)) 
                    for (let msg of newmsgs){
                        graphic.prepend(msg)
                    }
                    lastIdload=parseInt(GraphicChat.firstElementChild.dataset.id) 
                }                
            }   

        });

        const button = document.getElementById('buttonsearch');
        const menu = document.querySelector('.by');
        const InputSearch = document.getElementById("inputsearchuser");
        let timeout;

        function showMenu() {
            const rect = button.getBoundingClientRect();
            menu.style.display = 'flex';
            menu.style.position = 'absolute';
            menu.style.top = (rect.bottom + 2) + 'px';
            menu.style.left = rect.left + 'px';
            menu.style.minWidth = rect.width + 'px';
            setTimeout(() => menu.classList.add('show'), 10);
            clearTimeout(timeout);
        }

        function hideMenu() {
            menu.classList.remove('show');
            timeout = setTimeout(() => {
                menu.style.display = 'none';
            }, 200);
        }

        function showMenu_msg(x, y) {
            //msg_menu.remove("hidden_m")
            const menuRect = msg_menu.getBoundingClientRect();
            const padding = 8;
            let posX = x;
            let posY = y;
            // üëâ –Ω–µ –≤—ã–ª–µ–∑–∞—Ç—å –≤–ø—Ä–∞–≤–æ
            if (x + menuRect.width > window.innerWidth) {
                posX = window.innerWidth - menuRect.width - padding;
            }
            // üëâ –Ω–µ –≤—ã–ª–µ–∑–∞—Ç—å –≤–Ω–∏–∑
            if (y + menuRect.height > window.innerHeight) {
                posY = window.innerHeight - menuRect.height - padding;
            }
            // üëâ –Ω–µ –≤—ã–ª–µ–∑–∞—Ç—å –≤–ª–µ–≤–æ / –≤–≤–µ—Ä—Ö
            posX = Math.max(padding, posX);
            posY = Math.max(padding, posY);
            msg_menu.style.left = posX + "px";
            msg_menu.style.top = posY + "px";
            msg_menu.classList.remove("hidden_m")
            msg_menu.classList.add("show_m");
        }

        function hideMenu_msg() {
            msg_menu.classList.remove("show_m");
            msg_menu.classList.add("hidden_m");
            activeMessageId = null;
        }

        document.addEventListener("click",hideMenu_msg)

        document.getElementById("editMsg").addEventListener("click",function(){

        });

        document.getElementById("deleteMsg").addEventListener("click",function(){
            graphic.remove(activeMessageId);
            if (!("my" in activeMessageId)){
                ws.send(JSON.stringify({
                    id: activeMessageId
                }))
            }
        });

        button.addEventListener('mouseenter', showMenu);
        button.addEventListener('mouseleave', hideMenu);

        menu.addEventListener('mouseenter', function() {
            clearTimeout(timeout);
            menu.classList.add('show');
        });

        menu.addEventListener('mouseleave', hideMenu);

        const menuLinks = document.querySelectorAll('.by a');

        menuLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const linkText = this.textContent;
                console.log(`–ù–∞–∂–∞—Ç–∞ —Å—Å—ã–ª–∫–∞: ${linkText}`);
                switch (linkText) {
                    case 'Name':
                        SearchBy("name");
                        break;
                    case 'Phone':
                        SearchBy("phone");
                        break;
                    case 'Id':
                        SearchBy("id");
                        break;
                }

                this.closest('.by').style.display = 'none';
                document.querySelector("#SearchUser").style.display = "flex";
            });
        });

        GraphicChat.addEventListener("contextmenu", (e) => {
            e.preventDefault();

            const msgEl = e.target.closest(".message-right");
            if (!msgEl) return;

            activeMessageId = msgEl.dataset.id;
            console.log(activeMessageId);
            showMenu_msg(e.pageX, e.pageY);
        });

        document.addEventListener("click", async function(e) {
            if (e.target.className !== "zzz") {
                document.querySelector("#SearchUser").style.display = "none";
            }
            if (e.target.closest(".chatinfo")) {
                lastDate = null;
                document.getElementById("chatshape").style.display = "flex";
                GraphicChat.innerHTML = "";
                CurrentChat = e.target.closest(".chatinfo").dataset.chatId.substring(4);
                const chatmsgs = await messagedb.getChatMessages(parseInt(CurrentChat),20)
                    //console.log(chatmsgs)
                document.getElementById("shapechatavatar").src = ChatsData[CurrentChat].photo;
                document.getElementById("shapechatname").innerText = ChatsData[CurrentChat].name;
                console.log(ChatsData[CurrentChat].type)
                if (!(innerWidth > 480))
                    document.getElementById("chatbox").classList.add("hide");
                document.querySelectorAll(".wind").forEach(e => {
                    e.style.display = "flex"
                    if (innerWidth > 480)
                        e.style.width = "67%"
                })
                for (let msg of chatmsgs) {
                    await UpdateGUI(msg)
                }
            }
           //if (e.target.closest(".message-right")){
           //    e.target.closest(".message-right").dataset.id
           //}
        })
        document.getElementById("shapebackbtn").addEventListener("click", function() {
            document.querySelectorAll(".wind").forEach(e => {
                e.style.display = "none"
            })
            document.getElementById("chatbox").classList.remove("hide");
        })

        function SearchBy(type_search) {
            UserBox = document.getElementById("SearchUser");
            if (InputSearch.value.trim() != "") {
                fetch("/SearchUserBy", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "type": type_search,
                            "request": InputSearch.value.trim()
                        }),
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.sucess) {
                            const users = result.userlist;
                            UserBox.innerHTML = "";
                            users.forEach(user => {
                                if (user.photo === null) {
                                    user.photo = localStorage.getItem("avatar");
                                }
                                UserBox.innerHTML += `
                                    <div class=${'User'}>
                                        <img src="${user.photo}" class=${'useravatar'} alt="${0} ">
                                        <b class=${'username'} id=${user.id}>${user.name}</b> 
                                    </div>
                                `;
                            });
                        } else {
                            let name = "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
                            let photo = localStorage.getItem("notfind");
                            let id = "errorfind";
                            UserBox.innerHTML = `
                                <div class=${'User'}>
                                    <img src="${photo}" class=${'useravatar'} alt="${0} ">
                                    <b class=${'username'} id=${id}>${name}</b> 
                                </div>
                            `;
                        }

                    })
                    .catch(error => {
                        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
                    });
            }
        }

        document.getElementById('SearchUser').addEventListener('click', function(event) {
            const userElement = event.target.closest('.User');
            if (userElement) {
                const username = userElement.querySelector('.username');
                const userAvatar = userElement.querySelector('.useravatar');
                const userId = username.id;
                if (userId !== "errorfind") {
                    console.log("call false func")
                    CreateChat(flag = false, user = userId);
                }
            }
        });

        async function CreateChat(flag, use) {
            console.log(flag)
            var string = "";
            if (flag) {
                string = {
                    "email": user
                }
            } else {
                string = {
                    "id": user
                }
            }
            document.getElementById("MainChatCreator").style.display = "flex";
            var result = await GetUserInfo(string);
            var txt = "";
            if (!flag) {
                txt = `–í—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å ${result.name}`
            } else {
                txt = `${result.name} —Ö–æ—á–µ—Ç —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å –≤–∞–º–∏`
            }
            document.getElementById("usname").innerText = txt;
            if (result.photo) {
                result.photo = result.photo
            } else {
                result.photo = localStorage.getItem("avatar")
            }
            document.getElementById("user_ava").src = result.photo;
            document.querySelectorAll(".betta p").forEach(p => {
                if (p.textContent.trim().includes("–ò–º—è")) {
                    p.textContent = `–ò–º—è: ${result.name}`;
                } else if (p.textContent.trim().includes("–¢–µ–ª–µ—Ñ–æ–Ω")) {
                    p.textContent = `–¢–µ–ª–µ—Ñ–æ–Ω: ${result.phone}`;
                }
                if (p.textContent.trim().includes("ID")) {
                    p.textContent = `ID: ${result.userid}`;
                }
            });
            document.getElementById("create_chatbtn").addEventListener("click", async function(id = result.userid, email = result.email, publickey = result.publickey, publickeycrypt = result.publickeycrypt, f = flag) {
                if (!f) {
                    const keys = await generateEncryptionKeyPair()
                    const encryptedkey = await hybridEncrypt(keys.privateKey, result.publickeys.publickeycrypt)
                    const myencryptedkey = await hybridEncrypt(keys.privateKey, Data.publickeycrypt)
                        //localStorage.setItem(tempid,keys.privateKey)
                    ws.send(JSON.stringify({
                        type: "newchat",
                        email: email,
                        id: id,
                        publickey: keys.publicKey,
                        encrypted: encryptedkey,
                        myencrypted: myencryptedkey
                    }))
                } else {
                    ws.send(JSON.stringify({
                        type: "newchatagree",
                        email: email,
                        id: id,
                    }))
                }
                document.getElementById("MainChatCreator").style.display = "none";
            });
            document.getElementById("cancel").addEventListener("click", function(flag = flag, id = result.userid, email = result.email) {
                document.getElementById("MainChatCreator").style.display = "none";
                if (flag) {
                    ws.send(JSON.stringify({
                        type: "newchatdisagree",
                        email: email,
                        id: id,
                    }))
                }
            });
        }


        document.getElementById("exit").addEventListener("click", async function(e) {
            const res = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ?")
            if (res) {
                let res = await confirmIdentity(Data.my_id, Data.device_id, Data.email, Data.privatekey, Data.device, {
                    x: "removedevice",
                    device: Data.device
                });
                console.log(res);
                if (res.result === false && (res.what == "auth" || res.what == "server")) {
                    localStorage.clear();
                    window.close();
                    window.location.href = '/';
                    return true;
                } else if (res.result === true) {
                    if (res.result.answ == "yes") {
                        localStorage.clear();
                        window.close();
                        window.location.href = '/';
                    } else {
                        alert("–ú—ã –Ω–µ –º–æ–∂–µ–º —É–¥–∞–ª–∏—Ç—å –≤–∞—à–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–Ω–∞—á–µ –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É –±—É–¥–µ—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ –ø–æ—Ç–µ—Ä–µ–Ω, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –Ω–æ–≤–æ–µ , –∞ –∑–∞—Ç–µ–º –≤—ã–π–¥–∏—Ç–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ —ç—Ç–æ–º")
                    }
                }

            };
        });
        document.getElementById("deletemyacc").addEventListener("click", function(e) {
            document.getElementById("red").style.display = "flex";
            document.querySelectorAll(".deletebox").forEach(e => {
                e.style.display = "flex";
            });
        });

        document.getElementById("yesdelete").addEventListener("click", function(e) {
            document.querySelectorAll(".deletebox").forEach(e => {
                e.style.display = "none";
            });
            document.querySelectorAll(".why").forEach(e => {
                e.style.display = "flex";
            });
        });
        document.querySelectorAll(".no").forEach(e => {
            e.addEventListener("click", function(i) {
                document.getElementById("red").style.display = "none";
                document.querySelectorAll(".why").forEach(e => {
                    e.style.display = "none";
                });
            })
        })


        document.getElementById("yesdelete2").addEventListener("click", function(e) {
            let tx = document.getElementById("txa").value.trim();
            const Data = JSON.parse(localStorage.getItem("Userdata"));
            const result = confirmIdentity(Data.my_id, Data.device_id, Data.email, Data.privatekey, Data.device, {
                x: "del",
                "why": tx
            });
            console.log(result);
            if (result.success === false && result.what == "server") {
                alert("–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            }
            if (result.success === false && result.what == "auth") {
                alert("–û—à–∏–±–∫–∞ –∞—É—Ç–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –±—É–¥–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞");
            }
            if (result.success === true) {
                console.log('üéâ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                localStorage.removeItem("Userdata");
                window.location.herf = "/";
            }

        });

        const maleCheck = document.getElementById('MaleCheck');
        const femaleCheck = document.getElementById('FemaleChack');

        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        maleCheck.addEventListener('change', function() {
            if (this.checked) {
                femaleCheck.checked = false;
            }
        });

        femaleCheck.addEventListener('change', function() {
            if (this.checked) {
                maleCheck.checked = false;
            }
        });


        document.getElementById("profil").addEventListener("click", async function(e) {
            for (let e of document.querySelectorAll(".MainCreateProfil")) {
                e.style.display = "flex"
                var result = await GetUserInfo({
                    email: JSON.parse(localStorage.getItem("Userdata")).email
                })
                if (result.photo === null) {
                    result.photo = localStorage.getItem("avatar");
                }
                if (result.phone !== null) {
                    document.getElementById("PhoneINP").value = result.phone
                }
                if (result.age !== null) {
                    document.getElementById("AgeINP").value = result.age;
                }
                if (result.DR !== null) {
                    document.getElementById("DR").value = result.DR;
                }
                if (result.pol !== null) {
                    maleCheck.checked = false;
                    femaleCheck.checked = false;
                    switch (result.pol) {
                        case "–ú—É–∂":
                            maleCheck.checked = true;
                            break;
                        case "–ñ–µ–Ω":
                            femaleCheck.checked = true;
                            break;
                    }
                }
                document.getElementById("my_photo").src = result.photo;
                document.getElementById("Name_input").value = result.name;
            };
        });

        document.getElementById("prof_canc").addEventListener("click", function(e) {
            document.querySelectorAll(".MainCreateProfil").forEach(e => {
                e.style.display = "none";
            });
        });

        document.getElementById("prof_save").addEventListener("click", async function(e) {
            const strg = JSON.parse(localStorage.getItem("Userdata"));
            let pol = "–Ω–µ —É–∫–∞–∑–∞–Ω–æ";
            if (maleCheck.checked) {
                pol = "–ú—É–∂";
            }
            if (femaleCheck.checked) {
                pol = "–ñ–µ–Ω";
            }

            const ph = await getProfilePhotoData();

            const about = {
                name: document.getElementById("Name_input").value,
                phone: document.getElementById("PhoneINP").value,
                age: document.getElementById("AgeINP").value,
                DR: document.getElementById("DR").value,
                pol: pol,
                dopinf: document.getElementById("AboutMe").value,
                photo: ph
            }
            console.log(about);
            const result = await confirmIdentity(Data.my_id, Data.device_id, strg.email, strg.privatekey, strg.device, {
                x: "prof",
                data: about
            });

            if (result.result === true) {
                console.log('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                document.querySelector('.MainCreateProfil').style.display = 'none';
            }
            if (result.result === false && result.what === "auth") {
                alert('–û—à–∏–±–∫–∞ –∞—É—Ç–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                document.querySelector('.MainCreateProfil').style.display = 'none';
            }
            if (result.result === false && result.what === "server") {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                document.querySelector('.MainCreateProfil').style.display = 'none';
            }
        });

        let currentPhotoFile = null;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ "+" - –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫
        photoAdd.addEventListener('click', function(e) {
            e.preventDefault();
            photoUpload.click();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        photoUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                    return;
                }

                currentPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    myPhoto.src = e.target.result;
                    photoDelete.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–æ—Ä–∑–∏–Ω—É - —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
        photoDelete.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
            myPhoto.src = localStorage.getItem("avatar");
            currentPhotoFile = null;
            photoUpload.value = '';

            // –°–∫—Ä—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            photoDelete.style.display = 'none';
        });

        // Drag and Drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
        photoContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            photoContainer.style.borderColor = '#007bff';
        });

        photoContainer.addEventListener('dragleave', function(e) {
            e.preventDefault();
            photoContainer.style.borderColor = '#ccc';
        });

        photoContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            photoContainer.style.borderColor = '#ccc';

            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                    return;
                }

                currentPhotoFile = file;

                const reader = new FileReader();
                reader.onload = function(e) {
                    myPhoto.src = e.target.result;
                    photoDelete.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        });


        function loadExistingPhoto(photoBase64) {
            if (photoBase64) {
                myPhoto.src = photoBase64;
                photoDelete.style.display = 'flex';
                currentPhotoFile = null; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ–º base64
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
        function getProfilePhotoData() {
            if (currentPhotoFile) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç base64
                    };
                    reader.readAsDataURL(currentPhotoFile);
                });
            }
            return Promise.resolve(null);
        }



        async function confirmIdentity(id, device_id, email, privateKey, device_name, purpose = 'auth') {
            try {
                const challengeResponse = await fetch("/challenge", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        what: purpose
                    })
                });
                const challengeResult = await challengeResponse.json();
                if (challengeResult.success===false){
                    localStorage.clear()
                    //window.location.herf=""
                }
                if (!challengeResult.success) {
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å challenge');
                    localStorage.clear()
                    //window.location.herf=""
                    return {
                        result: false,
                        what: "server"
                    };
                }
                const challenge = challengeResult.challenge;
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω challenge –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                const signature = await signChallenge(challenge, privateKey);
                const verifyResponse = await fetch("/podpis", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        device_id: device_id,
                        email: email,
                        challenge: challenge,
                        signature: signature,
                        device: device_name,
                        what: purpose
                    })
                });

                const verifyResult = await verifyResponse.json();

                if (verifyResult.success) {
                    console.log('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                    return {
                        result: true,
                        what: "auth",
                        data: verifyResponse
                    };
                } else {
                    console.log('‚ùå –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', verifyResult.error);
                    return {
                        result: false,
                        what: "auth"
                    };
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', error);
                return {
                    result: false,
                    what: "server"
                };
            }
        }

        async function imageToBase64(url) {
            const res = await fetch(url);
            const blob = await res.blob();
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        function deepJsonParse(value) {
            let v = value;

            while (typeof v === "string") {
                v = JSON.parse(v.replace(/'/g, '"'));
            }

            return v;
        }

        async function GetUserInfo(jsonfetch) {
            var res = await fetch("/GetUserInfo", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonfetch),
            })
            var result = await res.json()
            if (result.photo === null || result.photo == "None") {
                result.photo = localStorage.getItem("avatar");
            }
            return result;
        }

        document.getElementById("delchat").addEventListener("click", function() {
            res = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —á–∞—Ç ?")
            if (res) {
                console.log("sending")
                ws.send(JSON.stringify({
                    type: "delchat",
                    id: CurrentChat
                }))
            }
        });

        async function Send_Message(msg, msgtype = "txt") {
            const randomNumber = Math.floor(1000 + Math.random() * 9000);
            if (msgtype === "txt") {
                var msgencrypt = await hybridEncrypt(msg, ChatsData[parseInt(CurrentChat)].publickeycrypt)
            } else {
                var msgencrypt = await encryptBlob(msg, ChatsData[parseInt(CurrentChat)].publickeycrypt)
            }
            msgencrypt = JSON.stringify(msgencrypt);
            if (msgtype==="img"){
                msg = await convertImage(msg)
            }
            const time = new Date()

            graphic.add({type: msgtype,
                            id: `my${randomNumber}`,
                            content: msg,
                            time: `${time.getHours()}:${time.getMinutes()}`,
                            namesender: "–í—ã",
                            classname: "message-right"

                        })
            document.getElementById("input_message").value = ""
            var msgs = {
                type: "newmessage",
                chatid: CurrentChat,
                userid: Data.my_id,
                typemsg: msgtype,
                message: msgencrypt,
                uniknownid: randomNumber,
                datatime: time
            }
            UnCookMessages[randomNumber] = msgs;
            if (ws.readyState === ws.OPEN){
                ws.send(JSON.stringify(msgs))
            }
            else{

            }

        }

        document.getElementById("send").addEventListener("click", async function() {
            const msg = document.getElementById("input_message").value
            if (msg !== "") {
                Send_Message(msg, "txt")
            }
        })

        const overlay = document.getElementById("imageOverlay");
        const previewImg = document.getElementById("imagePreview");

        const cancelBtn = document.getElementById("cancelImage");
        const sendBtn = document.getElementById("sendImage");

        let pastedImageFile = null;

        /* -------- PASTE HANDLER -------- */

        document.getElementById("input_message").addEventListener("paste", (e) => {
            const items = e.clipboardData.items;

            for (const item of items) {
                if (item.type.startsWith("image/")) {
                    e.preventDefault();

                    pastedImageFile = item.getAsFile();
                    showImagePreview(pastedImageFile);
                    return;
                }
            }
        });

        /* -------- SHOW PREVIEW -------- */

        function showImagePreview(file) {
            const reader = new FileReader();

            reader.onload = () => {
                previewImg.src = reader.result;
                overlay.classList.remove("hidden");
            };

            reader.readAsDataURL(file);
        }

        function convertImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        /* -------- CANCEL -------- */

        cancelBtn.addEventListener("click", () => {
            pastedImageFile = null;
            previewImg.src = "";
            overlay.classList.add("hidden");
        });

        /* -------- SEND (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞) -------- */
        async function blobToArrayBuffer(blob) {
            if (!(blob instanceof Blob)) {
                throw new Error("blobToArrayBuffer: input is NOT a Blob");
            }
            return await blob.arrayBuffer();
        }
        sendBtn.addEventListener("click", async function() {
            console.log(pastedImageFile instanceof Blob);
            console.log(pastedImageFile)
                //pastedImageFile = await blobToArrayBuffer(pastedImageFile, ChatsData[parseInt(CurrentChat)].publickeycrypt)
            await Send_Message(pastedImageFile, "img")
            pastedImageFile = null;
            overlay.classList.add("hidden");
        });

        async function loadBinary(path) {
            const res = await fetch(path);
            const buffer = await res.arrayBuffer();
            return buffer;
        }
        
        function arrayBufferToBase64(buffer) {
            let binary = "";
            const bytes = new Uint8Array(buffer);
            const chunkSize = 0x8000;
            for (let i = 0; i < bytes.length; i += chunkSize) {
                binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
            }
            return btoa(binary);
        }

        async function prepareEncryptedPackage(paths) {
            const [keyBuf, dataBuf, ivBuf] = await Promise.all([
                loadBinary(paths.encryptedKeyPath),
                loadBinary(paths.encryptedDataPath),
                loadBinary(paths.ivPath)
            ]);

            return {
                encryptedKey: arrayBufferToBase64(keyBuf),
                encryptedData: arrayBufferToBase64(dataBuf),
                iv: arrayBufferToBase64(ivBuf)
            };
        }

        async function GetName(id, photoflag = false) {
            var res = await fetch("/GetUs", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "photo": photoflag
                }),
            })
            var result = await res.json()
            return result;
        }

        function isSameDay(date1, date2) {
            if (date1 ===null){
                date1= new Date(0)
            }
            return date1.getFullYear() === date2.getFullYear() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getDate() === date2.getDate();
        }



        const stopBtn = document.getElementById("stopRec");
        const modal = document.getElementById("recordModal");
        const timeEl = document.getElementById("recordTime");

        let recorder;
        let stream;
        let chunks = [];
        let timer;
        let seconds = 0;

        mediabtn.addEventListener("click", startRecording);
        stopBtn.addEventListener("click", stopRecording);

        async function startRecording() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                recorder = new MediaRecorder(stream);
                chunks = [];

                recorder.ondataavailable = e => chunks.push(e.data);

                recorder.start();

                modal.style.display="flex";
                seconds = 0;
                timeEl.textContent = "00:00";
                timer = setInterval(() => {
                    seconds++;
                    const min = String(Math.floor(seconds / 60)).padStart(2, "0");
                    const sec = String(seconds % 60).padStart(2, "0");
                    timeEl.textContent = `${min}:${sec}`;
                }, 1000);

            } catch (e) {
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
                console.log(e);
            }
        }

        function stopRecording() {
            console.log("stop")
            modal.style.display="none";
            if (!recorder) return;

            recorder.stop();

            recorder.onstop = () => {
                clearInterval(timer);
                modal.classList.add("hidden");

                const blob = new Blob(chunks, { type: recorder.mimeType });
                stream.getTracks().forEach(t => t.stop());

                Send_Message(blob,"voice")
            };
        }


    });
</script>
</body>

</html>