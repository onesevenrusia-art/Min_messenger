<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</title>
</head>
<body>
    <h1>–¢–µ—Å—Ç RSA —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</h1>
    <button onclick="runTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <div id="result"></div>

    <script>
        // 1. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
        async function generateEncryptionKeyPair() {
            const keyPair = await crypto.subtle.generateKey(
                {
                    name: "RSA-OAEP",
                    modulusLength: 2048,
                    publicExponent: new Uint8Array([1, 0, 1]),
                    hash: "SHA-256",
                },
                true,
                ["encrypt", "decrypt"]
            );

            const exportedPublicKey = await crypto.subtle.exportKey("spki", keyPair.publicKey);
            const exportedPrivateKey = await crypto.subtle.exportKey("pkcs8", keyPair.privateKey);

            return {
                publicKey: arrayBufferToBase64(exportedPublicKey),
                privateKey: arrayBufferToBase64(exportedPrivateKey)
            };
        }

        // 3. –ò–º–ø–æ—Ä—Ç –∫–ª—é—á–µ–π
        async function importPublicKey(publicKeyB64) {
            const keyData = base64ToArrayBuffer(publicKeyB64);
            return await crypto.subtle.importKey(
                "spki",
                keyData,
                { name: "RSA-OAEP", hash: "SHA-256" },
                true,
                ["encrypt"]
            );
        }

        async function importPrivateKey(privateKeyB64) {
            const keyData = base64ToArrayBuffer(privateKeyB64);
            return await crypto.subtle.importKey(
                "pkcs8",
                keyData,
                { name: "RSA-OAEP", hash: "SHA-256" },
                true,
                ["decrypt"]
            );
        }

        // 4. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
        async function encryptMessage(message, publicKeyB64) {
            const publicKey = await importPublicKey(publicKeyB64);
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            
            const encryptedData = await crypto.subtle.encrypt(
                { name: "RSA-OAEP" },
                publicKey,
                data
            );
            
            return arrayBufferToBase64(encryptedData);
        }

        // 5. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
        async function decryptMessage(encryptedMessageB64, privateKeyB64) {
            const privateKey = await importPrivateKey(privateKeyB64);
            const encryptedData = base64ToArrayBuffer(encryptedMessageB64);
            
            const decryptedData = await crypto.subtle.decrypt(
                { name: "RSA-OAEP" },
                privateKey,
                encryptedData
            );
            
            const decoder = new TextDecoder();
            return decoder.decode(decryptedData);
        }

        // 6. –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç
        async function runTest() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞...</p>';
            
            try {
                // –®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
                resultDiv.innerHTML += '<p>üîê –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∫–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...</p>';
                const keys = await generateEncryptionKeyPair();
                resultDiv.innerHTML += `<p>‚úÖ –ö–ª—é—á–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã (–ø—É–±–ª–∏—á–Ω—ã–π: ${keys.publicKey.length} —Å–∏–º–≤–æ–ª–æ–≤)</p>`;

                // –®–∞–≥ 2: –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const originalMessage = "–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ 123!";
                resultDiv.innerHTML += `<p>üìù –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "${originalMessage}"</p>`;

                // –®–∞–≥ 3: –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
                resultDiv.innerHTML += '<p>üîí –®–∏—Ñ—Ä—É—é —Å–æ–æ–±—â–µ–Ω–∏–µ...</p>';
                const encrypted = await encryptMessage(originalMessage, keys.publicKey);
                resultDiv.innerHTML += `<p>‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ (${encrypted.length} —Å–∏–º–≤–æ–ª–æ–≤)</p>`;

                // –®–∞–≥ 4: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
                resultDiv.innerHTML += '<p>üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é —Å–æ–æ–±—â–µ–Ω–∏–µ...</p>';
                const decrypted = await decryptMessage(encrypted, keys.privateKey);
                resultDiv.innerHTML += `<p>‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ: "${decrypted}"</p>`;

                // –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞
                if (decrypted === originalMessage) {
                    resultDiv.innerHTML += '<p style="color: green; font-weight: bold;">üéâ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù –£–°–ü–ï–®–ù–û!</p>';
                } else {
                    resultDiv.innerHTML += '<p style="color: red; font-weight: bold;">‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù: —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</p>';
                }

            } catch (error) {
                resultDiv.innerHTML += `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>